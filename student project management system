<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Group Project Tracker</title>
  <style>
    /* Your existing CSS remains exactly the same */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #f4f6f9; 
      margin: 0; 
      padding: 0; 
      color: #333;
      line-height: 1.6;
    }
    
    header { 
      background: #4CAF50; 
      color: white; 
      padding: 20px; 
      text-align: center; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .hidden { 
      display: none; 
    }
    
    .container { 
      width: 90%; 
      max-width: 1200px; 
      margin: 30px auto; 
    }
    
    .card { 
      background: white; 
      padding: 25px; 
      margin: 20px 0; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    
    h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      border-bottom: 2px solid #eaeaea;
      padding-bottom: 10px;
    }
    
    h3 {
      color: #34495e;
      margin-bottom: 15px;
    }
    
    input, button, textarea, select { 
      width: 100%; 
      padding: 14px; 
      margin: 10px 0; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      font-family: inherit;
      font-size: 16px;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    }
    
    button { 
      background: #4CAF50; 
      color: white; 
      border: none; 
      cursor: pointer; 
      font-weight: 600;
      transition: all 0.3s;
    }
    
    button:hover { 
      background: #45a049; 
      transform: translateY(-2px);
    }
    
    button.secondary {
      background: #6c757d;
    }
    
    button.secondary:hover {
      background: #5a6268;
    }
    
    button.danger {
      background: #f44336;
    }
    
    button.danger:hover {
      background: #d32f2f;
    }
    
    .report { 
      padding: 12px 15px; 
      background: #e8f5e9; 
      margin: 10px 0; 
      border-radius: 8px; 
      border-left: 4px solid #4CAF50;
    }
    
    .chat-box { 
      max-height: 300px; 
      overflow-y: auto; 
      border: 1px solid #e0e0e0; 
      padding: 15px; 
      background: #fafafa; 
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .message { 
      padding: 10px 15px; 
      margin: 8px 0; 
      border-radius: 8px; 
    }
    
    .student-msg { 
      background: #e1f5fe; 
      border-left: 3px solid #03a9f4;
    }
    
    .my-msg {
      background: #e8f5e9;
      border-left: 3px solid #4CAF50;
      margin-left: 20%;
    }
    
    .chat-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 15px; 
    }
    
    .flex-buttons { 
      display: flex; 
      gap: 12px; 
    }
    
    .flex-buttons button { 
      width: auto; 
      padding: 10px 18px;
    }
    
    .alert { 
      padding: 14px; 
      border-radius: 8px; 
      margin: 15px 0; 
      font-weight: 500;
    }
    
    .alert-success { 
      background: #d4edda; 
      color: #155724; 
      border-left: 4px solid #28a745;
    }
    
    .alert-error { 
      background: #f8d7da; 
      color: #721c24; 
      border-left: 4px solid #dc3545;
    }
    
    .group-buttons { 
      display: flex; 
      gap: 12px; 
      margin-top: 15px; 
    }
    
    .group-buttons button { 
      width: auto; 
      padding: 10px 18px;
    }
    
    .user-info {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #f8f9fa;
      padding: 10px 18px;
      border-radius: 25px;
      font-size: 0.95em;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .user-info span {
      font-weight: 600;
      color: #4CAF50;
    }
    
    .timestamp {
      font-size: 0.75em;
      color: #777;
      margin-top: 5px;
      display: block;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
      overflow-x: auto;
    }
    
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .tab.active {
      border-bottom: 3px solid #4CAF50;
      color: #4CAF50;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .login-container {
      max-width: 450px;
      margin: 80px auto;
    }
    
    .group-card {
      border-left: 4px solid #4CAF50;
      margin-bottom: 25px;
    }
    
    .deadline {
      background: #fff3cd;
      padding: 10px 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #ffc107;
    }
    
    .deadline.urgent {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
    }
    
    .file-upload {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border: 2px dashed #dee2e6;
    }
    
    .file-list {
      margin-top: 10px;
    }
    
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: white;
      border-radius: 6px;
      margin: 5px 0;
      border: 1px solid #eee;
    }
    
    .notification-badge {
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      font-size: 0.7em;
      margin-left: 5px;
    }
    
    .notification-dot {
      width: 10px;
      height: 10px;
      background: #dc3545;
      border-radius: 50%;
      display: inline-block;
      margin-left: 5px;
    }
    
    .grade-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    
    .grade-table th, .grade-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    
    .grade-table th {
      background-color: #f4f6f9;
      font-weight: 600;
    }
    
    .grade-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .grade-input {
      width: 80px;
      padding: 8px;
      text-align: center;
    }
    
    .grade-summary {
      background: #e8f4f8;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    
    .grade-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
      margin-left: 10px;
    }
    
    .grade-A { background: #4CAF50; color: white; }
    .grade-B { background: #8BC34A; color: white; }
    .grade-C { background: #FFC107; color: black; }
    .grade-D { background: #FF9800; color: white; }
    .grade-F { background: #F44336; color: white; }
    
    @media (max-width: 768px) {
      .container {
        width: 95%;
      }
      
      .flex-buttons, .group-buttons {
        flex-direction: column;
      }
      
      .user-info {
        position: relative;
        top: 0;
        right: 0;
        margin-bottom: 20px;
        justify-content: center;
      }
      
      header {
        padding: 15px 10px;
      }
      
      .tab {
        padding: 10px 15px;
        font-size: 0.9em;
      }
      
      .grade-table {
        font-size: 0.85em;
      }
      
      .grade-input {
        width: 60px;
      }
    }
  </style>
  
  <!-- React CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>

<header>
  <h1>Student Group Project Management</h1>
  <div id="notificationArea" class="hidden"></div>
</header>

<!-- React Root -->
<div id="react-root"></div>

<!-- Your existing HTML structure (will be hidden initially) -->
<div class="container login-container" id="loginPage">
  <div class="card">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username (e.g. student1)">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p id="errorMsg" style="color:red; text-align: center; margin-top: 15px;"></p>
  </div>
</div>

<div id="teacherDashboard" class="container hidden">
  <!-- Your existing teacher dashboard HTML -->
</div>

<div id="studentDashboard" class="container hidden">
  <!-- Your existing student dashboard HTML -->
</div>

<script type="text/babel">
  // React Components
  const { useState, useEffect } = React;

  // React Login Component
  function ReactLogin() {
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const handleLogin = () => {
      if (users[username] && users[username].password === simpleHash(password)) {
        localStorage.setItem("loggedInUser", username);
        localStorage.setItem("role", users[username].role);
        setError('');
        // Trigger the original showDashboard function
        showDashboard(users[username].role, username);
      } else {
        setError('Invalid credentials!');
      }
    };

    return React.createElement('div', { className: 'container login-container' },
      React.createElement('div', { className: 'card' },
        React.createElement('h2', null, 'Login'),
        React.createElement('input', {
          type: 'text',
          placeholder: 'Username (e.g. student1)',
          value: username,
          onChange: (e) => setUsername(e.target.value)
        }),
        React.createElement('input', {
          type: 'password',
          placeholder: 'Password',
          value: password,
          onChange: (e) => setPassword(e.target.value)
        }),
        React.createElement('button', { onClick: handleLogin }, 'Login'),
        error && React.createElement('p', { 
          style: { color: 'red', textAlign: 'center', marginTop: '15px' } 
        }, error)
      )
    );
  }

  // React Teacher Dashboard Component
  function ReactTeacherDashboard({ username }) {
    const [activeTab, setActiveTab] = useState('createGroupTab');
    const [alert, setAlert] = useState({ message: '', type: '' });

    const showAlert = (message, type) => {
      setAlert({ message, type });
      setTimeout(() => setAlert({ message: '', type: '' }), 3000);
    };

    return React.createElement('div', { className: 'container' },
      React.createElement('div', { className: 'user-info' },
        'Logged in as: ',
        React.createElement('span', { id: 'teacherUsername' }, users[username].name),
        React.createElement('button', { 
          onClick: logout, 
          className: 'secondary',
          style: { padding: '6px 12px', fontSize: '0.85em' }
        }, 'Logout')
      ),
      
      React.createElement('h2', null, 'Teacher Dashboard'),
      
      alert.message && React.createElement('div', { 
        className: `alert alert-${alert.type === 'success' ? 'success' : 'error'}` 
      }, alert.message),
      
      React.createElement('div', { className: 'tabs' },
        ['Create Group', 'Manage Groups', 'Grading', 'Notifications'].map(tab => 
          React.createElement('div', {
            key: tab,
            className: `tab ${activeTab === `${tab.toLowerCase().replace(' ', '')}Tab` ? 'active' : ''}`,
            onClick: () => setActiveTab(`${tab.toLowerCase().replace(' ', '')}Tab`)
          }, tab)
        )
      ),
      
      // Tab content would go here in a full implementation
      React.createElement('div', null,
        'React Teacher Dashboard - This is where React components would replace existing functionality'
      )
    );
  }

  // Main React App Component
  function App() {
    const [currentView, setCurrentView] = useState('login');
    const [user, setUser] = useState(null);

    useEffect(() => {
      // Check if user is already logged in
      const loggedInUser = localStorage.getItem("loggedInUser");
      const role = localStorage.getItem("role");
      
      if (loggedInUser && role) {
        setUser({ username: loggedInUser, role });
        setCurrentView(role === 'teacher' ? 'teacher' : 'student');
      }
    }, []);

    const renderView = () => {
      switch (currentView) {
        case 'login':
          return React.createElement(ReactLogin);
        case 'teacher':
          return React.createElement(ReactTeacherDashboard, { username: user.username });
        case 'student':
          return React.createElement('div', { className: 'container' },
            'React Student Dashboard - Coming Soon'
          );
        default:
          return React.createElement(ReactLogin);
      }
    };

    return renderView();
  }

  // Initialize React
  ReactDOM.render(React.createElement(App), document.getElementById('react-root'));
</script>

<script>
  // Your original JavaScript code remains exactly the same
  // Simple hash function for password "hashing" (not secure, for demonstration only)
  function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i);
      hash |= 0; // Convert to 32bit integer
    }
    return hash.toString();
  }

  // Mock users with "hashed" passwords - TEACHER NAME CHANGED TO "Dinesh Kumar"
  const users = {
    "teacher": { password: simpleHash("admin"), role: "teacher", name: "Dinesh Kumar" },
    "student1": { password: simpleHash("pass1"), role: "student", name: "Alice Johnson" },
    "student2": { password: simpleHash("pass2"), role: "student", name: "Bob Williams" },
    "student3": { password: simpleHash("pass3"), role: "student", name: "Charlie Brown" },
    "student4": { password: simpleHash("pass4"), role: "student", name: "Diana Miller" },
    "student5": { password: simpleHash("pass5"), role: "student", name: "Ethan Davis" },
    "student6": { password: simpleHash("pass6"), role: "student", name: "Fiona Clark" },
    "student7": { password: simpleHash("pass7"), role: "student", name: "George Wilson" },
    "student8": { password: simpleHash("pass8"), role: "student", name: "Hannah Martinez" },
    "student9": { password: simpleHash("pass9"), role: "student", name: "Ian Anderson" },
    "student10": { password: simpleHash("pass10"), role: "student", name: "Jessica Taylor" }
  };

  // Load groups from localStorage or initialize with sample data
  let groups = JSON.parse(localStorage.getItem("groups")) || [
    {
      name: "Group A",
      students: ["student1", "student2", "student3"],
      project: {
        title: "Web Application",
        desc: "Build a responsive web application with user authentication",
        deadline: new Date(Date.now() + 30 * 86400000).toISOString().split('T')[0],
        milestones: [
          { title: "Design Phase", deadline: new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0], completed: true },
          { title: "Development Phase", deadline: new Date(Date.now() + 21 * 86400000).toISOString().split('T')[0], completed: false }
        ]
      },
      reports: [
        { student: "student1", text: "Worked on the login page design", timestamp: new Date(Date.now() - 86400000).toISOString(), files: [] },
        { student: "student2", text: "Set up the database schema", timestamp: new Date(Date.now() - 172800000).toISOString(), files: [] }
      ],
      chat: [
        { sender: "student1", text: "hi everyone", timestamp: new Date(Date.now() - 3600000).toISOString() },
        { sender: "student2", text: "hello!", timestamp: new Date(Date.now() - 1800000).toISOString() },
        { sender: "student1", text: "how's the project going?", timestamp: new Date(Date.now() - 600000).toISOString() }
      ],
      files: [],
      notifications: [],
      grades: {} // Added for grade management
    },
    {
      name: "Group B",
      students: ["student4", "student5", "student6"],
      project: {
        title: "Mobile App",
        desc: "Develop a cross-platform mobile application for task management",
        deadline: new Date(Date.now() + 45 * 86400000).toISOString().split('T')[0],
        milestones: [
          { title: "Research", deadline: new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0], completed: true },
          { title: "UI Design", deadline: new Date(Date.now() + 14 * 86400000).toISOString().split('T')[0], completed: false }
        ]
      },
      reports: [
        { student: "student4", text: "Created the initial app layout", timestamp: new Date(Date.now() - 259200000).toISOString(), files: [] }
      ],
      chat: [
        { sender: "student4", text: "Let's meet tomorrow at 3pm", timestamp: new Date(Date.now() - 86400000).toISOString() }
      ],
      files: [],
      notifications: [],
      grades: {} // Added for grade management
    }
  ];

  let currentStudentGroup = null;
  let lastChatCheck = {};
  let uploadedFiles = {};

  function login() {
    let username = document.getElementById("username").value.trim();
    let password = document.getElementById("password").value.trim();
    let errorMsg = document.getElementById("errorMsg");

    if (users[username] && users[username].password === simpleHash(password)) {
      localStorage.setItem("loggedInUser", username);
      localStorage.setItem("role", users[username].role);
      showDashboard(users[username].role, username);
      errorMsg.innerText = "";
    } else {
      errorMsg.innerText = "Invalid credentials!";
    }
  }

  function showDashboard(role, username) {
    document.getElementById("loginPage").classList.add("hidden");
    if (role === "teacher") {
      document.getElementById("teacherDashboard").classList.remove("hidden");
      document.getElementById("teacherUsername").textContent = users[username].name;
      updateGroupsList();
      checkTeacherNotifications();
      updateGradingTab(); // Added to initialize grading tab
    } else {
      document.getElementById("studentDashboard").classList.remove("hidden");
      document.getElementById("studentUsername").textContent = users[username].name;
      loadStudentView(username);
      // Initialize last chat check time
      lastChatCheck[username] = new Date().toISOString();
    }
  }

  function addMilestone() {
    const container = document.getElementById("milestonesContainer");
    const milestoneId = Date.now(); // Unique ID
    container.innerHTML += `
      <div class="milestone" id="milestone-${milestoneId}" style="display: flex; gap: 12px; align-items: center; margin: 10px 0;">
        <input type="text" placeholder="Milestone title" style="flex: 2;">
        <input type="date" style="flex: 1;">
        <button onclick="document.getElementById('milestone-${milestoneId}').remove()" class="danger" style="width: auto; padding: 10px;">Remove</button>
      </div>
    `;
  }

  function createGroup() {
    let groupName = document.getElementById("groupName").value.trim();
    let studentsInput = document.getElementById("studentList").value.trim();
    let projectTitle = document.getElementById("projectTitle").value.trim();
    let projectDesc = document.getElementById("projectDesc").value.trim();
    let projectDeadline = document.getElementById("projectDeadline").value;
    
    // Validate inputs
    if (!groupName || !studentsInput || !projectTitle) {
      showAlert("teacher", "Please fill all required fields", "error");
      return;
    }
    
    let students = studentsInput.split(",").map(s => s.trim());
    
    // Validate student usernames
    let invalidStudents = students.filter(s => !users[s] || users[s].role !== "student");
    if (invalidStudents.length > 0) {
      showAlert("teacher", `Invalid student usernames: ${invalidStudents.join(", ")}`, "error");
      return;
    }
    
    // Check if group name already exists
    if (groups.some(g => g.name === groupName)) {
      showAlert("teacher", "Group name already exists", "error");
      return;
    }

    // Collect milestones
    const milestones = [];
    const milestoneElements = document.querySelectorAll('.milestone');
    milestoneElements.forEach(el => {
      const title = el.querySelector('input[type="text"]').value.trim();
      const deadline = el.querySelector('input[type="date"]').value;
      if (title && deadline) {
        milestones.push({ title, deadline, completed: false });
      }
    });

    let group = { 
      name: groupName, 
      students, 
      project: { 
        title: projectTitle, 
        desc: projectDesc,
        deadline: projectDeadline,
        milestones 
      }, 
      reports: [], 
      chat: [],
      files: [],
      notifications: [`Group "${groupName}" was created with project "${projectTitle}"`],
      grades: {} // Initialize empty grades object
    };
    
    groups.push(group);
    localStorage.setItem("groups", JSON.stringify(groups));

    // Clear form
    document.getElementById("groupName").value = "";
    document.getElementById("studentList").value = "";
    document.getElementById("projectTitle").value = "";
    document.getElementById("projectDesc").value = "";
    document.getElementById("projectDeadline").value = "";
    document.getElementById("milestonesContainer").innerHTML = "";
    
    showAlert("teacher", "Group Created & Project Assigned!", "success");
    updateGroupsList();
    updateGradingTab(); // Update grading tab with new group
  }

  function updateGroupsList() {
    let list = document.getElementById("groupsList");
    list.innerHTML = "";
    
    if (groups.length === 0) {
      list.innerHTML = "<p>No groups created yet.</p>";
      return;
    }
    
    groups.forEach((group, index) => {
      // Check if project is nearing deadline (within 7 days)
      const today = new Date();
      const deadline = new Date(group.project.deadline);
      const daysUntilDeadline = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
      const isDeadlineNear = daysUntilDeadline <= 7 && daysUntilDeadline >= 0;
      
      list.innerHTML += `
        <div class="card group-card">
          <b>${group.name}</b> ${isDeadlineNear ? '<span style="color: #dc3545;">(Deadline approaching!)</span>' : ''}<br>
          <p><strong>Students:</strong> ${group.students.join(", ")}</p>
          <p><strong>Project:</strong> ${group.project.title} - ${group.project.desc}</p>
          <p><strong>Deadline:</strong> ${formatDate(group.project.deadline)} (${daysUntilDeadline} days left)</p>
          ${group.project.milestones && group.project.milestones.length > 0 ? `
            <p><strong>Milestones:</strong></p>
            <ul>${group.project.milestones.map(m => `
              <li>${m.title} - ${formatDate(m.deadline)} ${m.completed ? '✅' : '⏳'}</li>
            `).join("")}</ul>
          ` : ''}
          ${group.reports.length > 0 ? `
            <p><strong>Recent Reports:</strong></p>
            <ul>${group.reports.slice(-3).map(r => `
              <li>${r.student}: ${r.text} <span class="timestamp">${formatDate(r.timestamp)}</span></li>
            `).join("")}</ul>
          ` : "<p>No progress reports yet.</p>"}
          <div class="group-buttons">
            <button onclick="editGroup(${index})" class="secondary">Edit Group</button>
            <button onclick="deleteGroup(${index})" class="danger">Delete Group</button>
          </div>
        </div>
      `;
    });
  }

  function editGroup(index) {
    let group = groups[index];
    document.getElementById("groupName").value = group.name;
    document.getElementById("studentList").value = group.students.join(", ");
    document.getElementById("projectTitle").value = group.project.title;
    document.getElementById("projectDesc").value = group.project.desc;
    document.getElementById("projectDeadline").value = group.project.deadline;
    
    // Add milestones to form
    const milestonesContainer = document.getElementById("milestonesContainer");
    milestonesContainer.innerHTML = "";
    if (group.project.milestones && group.project.milestones.length > 0) {
      group.project.milestones.forEach(milestone => {
        const milestoneId = Date.now();
        milestonesContainer.innerHTML += `
          <div class="milestone" id="milestone-${milestoneId}" style="display: flex; gap: 12px; align-items: center; margin: 10px 0;">
            <input type="text" placeholder="Milestone title" value="${milestone.title}" style="flex: 2;">
            <input type="date" value="${milestone.deadline}" style="flex: 1;">
            <button onclick="document.getElementById('milestone-${milestoneId}').remove()" class="danger" style="width: auto; padding: 10px;">Remove</button>
          </div>
        `;
      });
    }
    
    // Switch to create group tab
    switchTab(null, 'createGroupTab');
    
    // Remove the group from the list (will be re-added with updated info)
    groups.splice(index, 1);
    localStorage.setItem("groups", JSON.stringify(groups));
    updateGroupsList();
    
    showAlert("teacher", "You can now edit the group details", "success");
  }

  function deleteGroup(index) {
    if (confirm(`Are you sure you want to delete the group "${groups[index].name}"?`)) {
      groups.splice(index, 1);
      localStorage.setItem("groups", JSON.stringify(groups));
      updateGroupsList();
      updateGradingTab(); // Update grading tab after deletion
      showAlert("teacher", "Group deleted successfully", "success");
    }
  }

  // NEW FUNCTION: Update grading tab with groups and grading interface
  function updateGradingTab() {
    const container = document.getElementById("gradingContainer");
    container.innerHTML = "";
    
    if (groups.length === 0) {
      container.innerHTML = "<p>No groups created yet.</p>";
      return;
    }
    
    groups.forEach((group, groupIndex) => {
      const groupCard = document.createElement("div");
      groupCard.className = "card";
      groupCard.innerHTML = `
        <h3>Grade: ${group.name}</h3>
        <p><strong>Project:</strong> ${group.project.title}</p>
        <p><strong>Students:</strong> ${group.students.join(", ")}</p>
        
        <table class="grade-table">
          <thead>
            <tr>
              <th>Student</th>
              <th>Grade (0-100)</th>
              <th>Letter Grade</th>
              <th>Feedback</th>
            </tr>
          </thead>
          <tbody id="gradeTable-${groupIndex}">
          </tbody>
        </table>
        
        <div class="grade-summary">
          <h4>Group Summary</h4>
          <div id="groupSummary-${groupIndex}">No grades entered yet</div>
        </div>
        
        <button onclick="saveGrades(${groupIndex})" style="margin-top: 15px;">Save Grades</button>
      `;
      
      container.appendChild(groupCard);
      
      // Fill in the grade table
      const tableBody = document.getElementById(`gradeTable-${groupIndex}`);
      group.students.forEach((student, studentIndex) => {
        const grade = group.grades && group.grades[student] ? group.grades[student].grade : "";
        const feedback = group.grades && group.grades[student] ? group.grades[student].feedback : "";
        const letterGrade = calculateLetterGrade(grade);
        
        tableBody.innerHTML += `
          <tr>
            <td>${student}</td>
            <td>
              <input type="number" min="0" max="100" class="grade-input" 
                     id="grade-${groupIndex}-${studentIndex}" 
                     value="${grade}" 
                     onchange="updateLetterGrade(${groupIndex}, ${studentIndex})">
            </td>
            <td id="letterGrade-${groupIndex}-${studentIndex}">
              ${letterGrade ? `<span class="grade-badge grade-${letterGrade}">${letterGrade}</span>` : ""}
            </td>
            <td>
              <input type="text" 
                     id="feedback-${groupIndex}-${studentIndex}" 
                     value="${feedback}" 
                     placeholder="Optional feedback">
            </td>
          </tr>
        `;
      });
      
      updateGroupSummary(groupIndex);
    });
  }
  
  // NEW FUNCTION: Calculate letter grade based on numerical grade
  function calculateLetterGrade(grade) {
    if (!grade || isNaN(grade)) return "";
    if (grade >= 90) return "A";
    if (grade >= 80) return "B";
    if (grade >= 70) return "C";
    if (grade >= 60) return "D";
    return "F";
  }
  
  // NEW FUNCTION: Update letter grade display when numerical grade changes
  function updateLetterGrade(groupIndex, studentIndex) {
    const gradeInput = document.getElementById(`grade-${groupIndex}-${studentIndex}`);
    const letterGradeCell = document.getElementById(`letterGrade-${groupIndex}-${studentIndex}`);
    const grade = parseInt(gradeInput.value);
    
    if (!isNaN(grade) && grade >= 0 && grade <= 100) {
      const letterGrade = calculateLetterGrade(grade);
      letterGradeCell.innerHTML = `<span class="grade-badge grade-${letterGrade}">${letterGrade}</span>`;
    } else {
      letterGradeCell.innerHTML = "";
    }
    
    updateGroupSummary(groupIndex);
  }
  
  // NEW FUNCTION: Update group summary statistics
  function updateGroupSummary(groupIndex) {
    const group = groups[groupIndex];
    const summaryElement = document.getElementById(`groupSummary-${groupIndex}`);
    const grades = [];
    
    group.students.forEach((student, studentIndex) => {
      const gradeInput = document.getElementById(`grade-${groupIndex}-${studentIndex}`);
      const grade = parseInt(gradeInput.value);
      
      if (!isNaN(grade) && grade >= 0 && grade <= 100) {
        grades.push(grade);
      }
    });
    
    if (grades.length === 0) {
      summaryElement.innerHTML = "No grades entered yet";
      return;
    }
    
    const average = grades.reduce((a, b) => a + b, 0) / grades.length;
    const min = Math.min(...grades);
    const max = Math.max(...grades);
    
    summaryElement.innerHTML = `
      <p><strong>Average:</strong> ${average.toFixed(1)}% (${calculateLetterGrade(average)})</p>
      <p><strong>Range:</strong> ${min}% - ${max}%</p>
      <p><strong>Graded:</strong> ${grades.length} of ${group.students.length} students</p>
    `;
  }
  
  // NEW FUNCTION: Save grades for a group
  function saveGrades(groupIndex) {
    const group = groups[groupIndex];
    
    group.students.forEach((student, studentIndex) => {
      const gradeInput = document.getElementById(`grade-${groupIndex}-${studentIndex}`);
      const feedbackInput = document.getElementById(`feedback-${groupIndex}-${studentIndex}`);
      const grade = parseInt(gradeInput.value);
      
      if (!group.grades) {
        group.grades = {};
      }
      
      if (!isNaN(grade) && grade >= 0 && grade <= 100) {
        group.grades[student] = {
          grade: grade,
          feedback: feedbackInput.value,
          timestamp: new Date().toISOString()
        };
      } else if (gradeInput.value === "") {
        // Clear grade if input is empty
        if (group.grades[student]) {
          delete group.grades[student];
        }
      }
    });
    
    localStorage.setItem("groups", JSON.stringify(groups));
    showAlert("teacher", "Grades saved successfully!", "success");
    updateGroupSummary(groupIndex);
    
    // Add notification
    group.notifications.push(`Grades updated for ${group.name}`);
    
    // Update student views if they're logged in
    updateStudentGradeDisplays();
  }
  
  // NEW FUNCTION: Update grade displays for students
  function updateStudentGradeDisplays() {
    const currentUser = localStorage.getItem("loggedInUser");
    const role = localStorage.getItem("role");
    
    if (role === "student") {
      loadStudentView(currentUser);
    }
  }

  function loadStudentView(username) {
    let group = groups.find(g => g.students.includes(username));
    if (group) {
      document.getElementById("studentGroup").innerText = `Group: ${group.name}`;
      document.getElementById("studentProject").innerHTML = `<b>${group.project.title}</b><br>${group.project.desc}`;
      
      // Show deadline information
      const today = new Date();
      const deadline = new Date(group.project.deadline);
      const daysUntilDeadline = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
      
      let deadlineClass = "deadline";
      if (daysUntilDeadline <= 7 && daysUntilDeadline >= 0) {
        deadlineClass += " urgent";
      }
      
      document.getElementById("studentDeadline").innerHTML = `
        <div class="${deadlineClass}">
          <strong>Project Deadline:</strong> ${formatDate(group.project.deadline)} 
          (${daysUntilDeadline > 0 ? `${daysUntilDeadline} days left` : 'Deadline passed!'})
        </div>
      `;
      
      // NEW: Display grade if available
      const gradeDisplay = document.getElementById("gradeDisplay");
      const studentGradeSection = document.getElementById("studentGrade");
      
      if (group.grades && group.grades[username]) {
        const gradeData = group.grades[username];
        const letterGrade = calculateLetterGrade(gradeData.grade);
        
        gradeDisplay.innerHTML = `
          <div class="grade-summary">
            <p><strong>Grade:</strong> ${gradeData.grade}% 
              <span class="grade-badge grade-${letterGrade}">${letterGrade}</span>
            </p>
            ${gradeData.feedback ? `<p><strong>Feedback:</strong> ${gradeData.feedback}</p>` : ""}
            <span class="timestamp">Graded on: ${formatDate(gradeData.timestamp)}</span>
          </div>
        `;
        studentGradeSection.classList.remove("hidden");
      } else {
        studentGradeSection.classList.add("hidden");
      }
      
      updateProgressList(group);
      updateChat(group);
      updateSharedFiles(group);
      checkChatNotifications(username, group);
      currentStudentGroup = group;
    } else {
      document.getElementById("studentGroup").innerText = "You are not assigned to any group yet.";
      document.getElementById("studentGrade").classList.add("hidden");
    }
    
    // Handle file input change
    document.getElementById('fileUpload').addEventListener('change', handleFileSelect);
  }

  function handleFileSelect(event) {
    const files = event.target.files;
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '';
    uploadedFiles = {}; // Reset
    
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      uploadedFiles[file.name] = file;
      
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';
      fileItem.innerHTML = `
        <span>${file.name}</span>
        <span>(${formatFileSize(file.size)})</span>
      `;
      fileList.appendChild(fileItem);
    }
  }

  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' bytes';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / 1048576).toFixed(1) + ' MB';
  }

  function submitReport() {
    let username = localStorage.getItem("loggedInUser");
    let reportText = document.getElementById("progressReport").value.trim();
    
    if (!reportText) {
      showAlert("student", "Write your progress first!", "error");
      return;
    }

    let group = groups.find(g => g.students.includes(username));
    if (group) {
      // Get file information
      const fileNames = Object.keys(uploadedFiles);
      
      group.reports.push({ 
        student: username, 
        text: reportText,
        timestamp: new Date().toISOString(),
        files: fileNames
      });
      
      // Add notification for teacher
      group.notifications.push(`${username} submitted a progress report in ${group.name}`);
      
      localStorage.setItem("groups", JSON.stringify(groups));
      showAlert("student", "Progress Submitted!", "success");
      updateProgressList(group);
      document.getElementById("progressReport").value = "";
      document.getElementById("fileList").innerHTML = "";
      document.getElementById("fileUpload").value = "";
      uploadedFiles = {};
      
      // Update teacher notifications if teacher is logged in
      if (localStorage.getItem("role") === "teacher") {
        checkTeacherNotifications();
      }
    }
  }

  function updateProgressList(group) {
    let list = document.getElementById("progressList");
    
    if (group.reports.length === 0) {
      list.innerHTML = "<p>No progress reports yet.</p>";
      return;
    }
    
    list.innerHTML = group.reports.map(r => `
      <div class="report">
        <b>${r.student}</b>: ${r.text}
        ${r.files && r.files.length > 0 ? `
          <div><strong>Attachments:</strong> ${r.files.join(', ')}</div>
        ` : ''}
        <span class="timestamp">${formatDate(r.timestamp)}</span>
      </div>
    `).reverse().join("");
  }

  function sendMessage() {
    let username = localStorage.getItem("loggedInUser");
    let msg = document.getElementById("chatMessage").value.trim();
    
    if (!msg) {
      showAlert("student", "Message cannot be empty!", "error");
      return;
    }

    let group = groups.find(g => g.students.includes(username));
    if (group) {
      group.chat.push({ 
        sender: username, 
        text: msg,
        timestamp: new Date().toISOString()
      });
      
      // Notify other group members of new message
      group.students.forEach(student => {
        if (student !== username) {
          if (!group.notifications) group.notifications = [];
          group.notifications.push(`New message from ${username} in ${group.name}`);
        }
      });
      
      localStorage.setItem("groups", JSON.stringify(groups));
      updateChat(group);
      document.getElementById("chatMessage").value = "";
      
      // Update notification badges for other group members if they're logged in
      updateChatNotificationBadges(group);
    }
  }
  
  function clearChat() {
    let username = localStorage.getItem("loggedInUser");
    let group = groups.find(g => g.students.includes(username));
    
    if (group) {
      if (confirm("Are you sure you want to clear the entire chat history?")) {
        group.chat = [];
        localStorage.setItem("groups", JSON.stringify(groups));
        updateChat(group);
        showAlert("student", "Chat cleared successfully", "success");
      }
    }
  }
  
  function refreshChat() {
    let username = localStorage.getItem("loggedInUser");
    let group = groups.find(g => g.students.includes(username));
    
    if (group) {
      updateChat(group);
      // Reset notification badge
      document.getElementById("chatNotificationBadge").classList.add("hidden");
      lastChatCheck[username] = new Date().toISOString();
      showAlert("student", "Chat refreshed", "success");
    }
  }
  
  function showAlert(dashboard, message, type) {
    const alertElement = document.getElementById(`${dashboard}Alert`);
    alertElement.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'error'}">${message}</div>`;
    
    // Auto-hide alert after 3 seconds
    setTimeout(() => {
      alertElement.innerHTML = "";
    }, 3000);
  }

  function updateChat(group) {
    let chatBox = document.getElementById("chatBox");
    let currentUser = localStorage.getItem("loggedInUser");
    
    if (group.chat.length === 0) {
      chatBox.innerHTML = "<p>No messages yet. Start the conversation!</p>";
      return;
    }
    
    chatBox.innerHTML = group.chat.map(m => `
      <div class="message ${m.sender === currentUser ? 'my-msg' : 'student-msg'}">
        <b>${m.sender}:</b> ${m.text}
        <span class="timestamp">${formatTime(m.timestamp)}</span>
      </div>
    `).join("");
    
    chatBox.scrollTop = chatBox.scrollHeight;
  }
  
  function checkChatNotifications(username, group) {
    if (!group || !group.chat || group.chat.length === 0) return;
    
    const lastMessageTime = group.chat[group.chat.length - 1].timestamp;
    
    if (!lastChatCheck[username] || new Date(lastMessageTime) > new Date(lastChatCheck[username])) {
      document.getElementById("chatNotificationBadge").classList.remove("hidden");
      document.getElementById("chatNotificationBadge").textContent = "!";
    }
  }
  
  function updateChatNotificationBadges(group) {
    if (!group || !group.students) return;
    
    group.students.forEach(student => {
      if (student !== localStorage.getItem("loggedInUser") && users[student]) {
        // In a real application, you would send a notification to the user
        // For this demo, we'll just update the UI if the user is currently logged in
        if (localStorage.getItem("loggedInUser") === student) {
          document.getElementById("chatNotificationBadge").classList.remove("hidden");
          document.getElementById("chatNotificationBadge").textContent = "!";
        }
      }
    });
  }

  function formatDate(dateString) {
    if (!dateString) return "No date set";
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }
  
  function formatTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }
  
  // FIXED: Tab switching function with proper event handling
  function switchTab(event, tabId, dashboard = '') {
    // For teacher dashboard
    if (!dashboard) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Activate the clicked tab
      if (event && event.target) {
        event.target.classList.add('active');
      }
      document.getElementById(tabId).classList.add('active');
      
      // Special handling for certain tabs
      if (tabId === 'gradingTab') {
        updateGradingTab();
      } else if (tabId === 'notificationsTab') {
        document.getElementById("teacherNotificationBadge").classList.add("hidden");
        updateTeacherNotifications();
      }
    } 
    // For student dashboard
    else {
      document.querySelectorAll(`#${dashboard}Dashboard .tab`).forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll(`#${dashboard}Dashboard .tab-content`).forEach(content => content.classList.remove('active'));
      
      // Activate the clicked tab
      if (event && event.target) {
        event.target.classList.add('active');
      }
      document.getElementById(tabId).classList.add('active');
      
      // If switching to chat tab, clear notification badge
      if (tabId === 'chatTab') {
        document.getElementById("chatNotificationBadge").classList.add("hidden");
        const username = localStorage.getItem("loggedInUser");
        if (username) lastChatCheck[username] = new Date().toISOString();
      }
    }
  }

  function checkTeacherNotifications() {
    let notificationCount = 0;
    groups.forEach(group => {
      if (group.notifications && group.notifications.length > 0) {
        notificationCount += group.notifications.length;
      }
    });
    
    if (notificationCount > 0) {
      document.getElementById("teacherNotificationBadge").classList.remove("hidden");
      document.getElementById("teacherNotificationBadge").textContent = notificationCount;
    } else {
      document.getElementById("teacherNotificationBadge").classList.add("hidden");
    }
  }
  
  function updateTeacherNotifications() {
    const container = document.getElementById("teacherNotifications");
    container.innerHTML = "";
    
    let allNotifications = [];
    
    groups.forEach(group => {
      if (group.notifications && group.notifications.length > 0) {
        group.notifications.forEach(notification => {
          allNotifications.push({
            text: notification,
            group: group.name,
            timestamp: new Date().toISOString() // In a real app, you'd store actual timestamps
          });
        });
      }
    });
    
    if (allNotifications.length === 0) {
      container.innerHTML = "<p>No notifications</p>";
      return;
    }
    
    // Show most recent first
    allNotifications.reverse().forEach(notification => {
      container.innerHTML += `
        <div class="report">
          <b>${notification.group}</b>: ${notification.text}
          <span class="timestamp">${formatDate(notification.timestamp)}</span>
        </div>
      `;
    });
  }

  function uploadFile() {
    const fileInput = document.getElementById('groupFileUpload');
    const username = localStorage.getItem("loggedInUser");
    
    if (fileInput.files.length === 0) {
      showAlert("student", "Please select a file to upload", "error");
      return;
    }
    
    const file = fileInput.files[0];
    const group = groups.find(g => g.students.includes(username));
    
    if (group) {
      if (!group.files) group.files = [];
      
      group.files.push({
        name: file.name,
        size: file.size,
        uploadedBy: username,
        timestamp: new Date().toISOString()
      });
      
      // Add notification
      group.notifications.push(`${username} uploaded a file: ${file.name} in ${group.name}`);
      
      localStorage.setItem("groups", JSON.stringify(groups));
      showAlert("student", "File uploaded successfully", "success");
      updateSharedFiles(group);
      fileInput.value = "";
      
      // Update teacher notifications if teacher is logged in
      if (localStorage.getItem("role") === "teacher") {
        checkTeacherNotifications();
      }
    }
  }
  
  function updateSharedFiles(group) {
    const container = document.getElementById("sharedFilesList");
    
    if (!group.files || group.files.length === 0) {
      container.innerHTML = "<p>No files shared yet</p>";
      return;
    }
    
    container.innerHTML = "<h4>Shared Files:</h4>";
    
    group.files.forEach(file => {
      container.innerHTML += `
        <div class="file-item">
          <div>
            <strong>${file.name}</strong>
            <div>Uploaded by ${file.uploadedBy} • ${formatFileSize(file.size)}</div>
            <span class="timestamp">${formatDate(file.timestamp)}</span>
          </div>
          <button class="secondary" style="width: auto;">Download</button>
        </div>
      `;
    });
  }

  function logout() {
    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("role");
    location.reload();
  }

  // Auto-login if session exists
  window.onload = () => {
    let user = localStorage.getItem("loggedInUser");
    let role = localStorage.getItem("role");
    if (user && role) showDashboard(role, user);
  };
</script>

</body>
</html>
