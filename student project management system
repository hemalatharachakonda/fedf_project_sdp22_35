<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Group Project Tracker</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #f4f6f9; 
      margin: 0; 
      padding: 0; 
      color: #333;
      line-height: 1.6;
    }
    
    header { 
      background: #4CAF50; 
      color: white; 
      padding: 20px; 
      text-align: center; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .hidden { 
      display: none; 
    }
    
    .container { 
      width: 90%; 
      max-width: 1200px; 
      margin: 30px auto; 
    }
    
    .card { 
      background: white; 
      padding: 25px; 
      margin: 20px 0; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    
    h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      border-bottom: 2px solid #eaeaea;
      padding-bottom: 10px;
    }
    
    h3 {
      color: #34495e;
      margin-bottom: 15px;
    }
    
    input, button, textarea, select { 
      width: 100%; 
      padding: 14px; 
      margin: 10px 0; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      font-family: inherit;
      font-size: 16px;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    }
    
    button { 
      background: #4CAF50; 
      color: white; 
      border: none; 
      cursor: pointer; 
      font-weight: 600;
      transition: all 0.3s;
    }
    
    button:hover { 
      background: #45a049; 
      transform: translateY(-2px);
    }
    
    button.secondary {
      background: #6c757d;
    }
    
    button.secondary:hover {
      background: #5a6268;
    }
    
    button.danger {
      background: #f44336;
    }
    
    button.danger:hover {
      background: #d32f2f;
    }
    
    .report { 
      padding: 12px 15px; 
      background: #e8f5e9; 
      margin: 10px 0; 
      border-radius: 8px; 
      border-left: 4px solid #4CAF50;
    }
    
    .chat-box { 
      max-height: 300px; 
      overflow-y: auto; 
      border: 1px solid #e0e0e0; 
      padding: 15px; 
      background: #fafafa; 
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .message { 
      padding: 10px 15px; 
      margin: 8px 0; 
      border-radius: 8px; 
    }
    
    .student-msg { 
      background: #e1f5fe; 
      border-left: 3px solid #03a9f4;
    }
    
    .my-msg {
      background: #e8f5e9;
      border-left: 3px solid #4CAF50;
      margin-left: 20%;
    }
    
    .chat-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 15px; 
    }
    
    .flex-buttons { 
      display: flex; 
      gap: 12px; 
    }
    
    .flex-buttons button { 
      width: auto; 
      padding: 10px 18px;
    }
    
    .alert { 
      padding: 14px; 
      border-radius: 8px; 
      margin: 15px 0; 
      font-weight: 500;
    }
    
    .alert-success { 
      background: #d4edda; 
      color: #155724; 
      border-left: 4px solid #28a745;
    }
    
    .alert-error { 
      background: #f8d7da; 
      color: #721c24; 
      border-left: 4px solid #dc3545;
    }
    
    .group-buttons { 
      display: flex; 
      gap: 12px; 
      margin-top: 15px; 
    }
    
    .group-buttons button { 
      width: auto; 
      padding: 10px 18px;
    }
    
    .user-info {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #f8f9fa;
      padding: 10px 18px;
      border-radius: 25px;
      font-size: 0.95em;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .user-info span {
      font-weight: 600;
      color: #4CAF50;
    }
    
    .timestamp {
      font-size: 0.75em;
      color: #777;
      margin-top: 5px;
      display: block;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
      overflow-x: auto;
    }
    
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .tab.active {
      border-bottom: 3px solid #4CAF50;
      color: #4CAF50;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .login-container {
      max-width: 450px;
      margin: 80px auto;
    }
    
    .group-card {
      border-left: 4px solid #4CAF50;
      margin-bottom: 25px;
    }
    
    .deadline {
      background: #fff3cd;
      padding: 10px 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #ffc107;
    }
    
    .deadline.urgent {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
    }
    
    .file-upload {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border: 2px dashed #dee2e6;
    }
    
    .file-list {
      margin-top: 10px;
    }
    
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: white;
      border-radius: 6px;
      margin: 5px 0;
      border: 1px solid #eee;
    }
    
    .notification-badge {
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      font-size: 0.7em;
      margin-left: 5px;
    }
    
    .notification-dot {
      width: 10px;
      height: 10px;
      background: #dc3545;
      border-radius: 50%;
      display: inline-block;
      margin-left: 5px;
    }
    
    .grade-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    
    .grade-table th, .grade-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    
    .grade-table th {
      background-color: #f4f6f9;
      font-weight: 600;
    }
    
    .grade-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .grade-input {
      width: 80px;
      padding: 8px;
      text-align: center;
    }
    
    .grade-summary {
      background: #e8f4f8;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    
    .grade-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
      margin-left: 10px;
    }
    
    .grade-A { background: #4CAF50; color: white; }
    .grade-B { background: #8BC34A; color: white; }
    .grade-C { background: #FFC107; color: black; }
    .grade-D { background: #FF9800; color: white; }
    .grade-F { background: #F44336; color: white; }
    
    /* NEW STYLES FOR PROJECT HISTORY */
    .project-history {
      margin-top: 30px;
    }
    
    .history-tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    
    .history-tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 500;
    }
    
    .history-tab.active {
      border-bottom: 3px solid #4CAF50;
      color: #4CAF50;
    }
    
    .project-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .project-card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .project-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .project-header {
      padding: 15px;
      background: #4CAF50;
      color: white;
    }
    
    .project-body {
      padding: 15px;
    }
    
    .project-type {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 15px;
      background: #e8f4f8;
      color: #2c3e50;
      font-size: 0.8em;
      margin-top: 5px;
    }
    
    .project-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.2em;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .stat-label {
      font-size: 0.8em;
      color: #777;
    }
    
    .archive-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    
    .archive-btn:hover {
      background: #5a6268;
    }
    
    .portfolio-summary {
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .portfolio-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .portfolio-stat {
      text-align: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
    }
    
    .portfolio-value {
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .portfolio-label {
      font-size: 0.9em;
      opacity: 0.9;
    }
    
    .project-filter {
      margin: 15px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .filter-btn {
      padding: 8px 15px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .filter-btn.active {
      background: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }
    
    .teacher-selector {
      margin: 15px 0;
      padding: 15px;
      background: #e8f4f8;
      border-radius: 8px;
    }
    
    @media (max-width: 768px) {
      .container {
        width: 95%;
      }
      
      .flex-buttons, .group-buttons {
        flex-direction: column;
      }
      
      .user-info {
        position: relative;
        top: 0;
        right: 0;
        margin-bottom: 20px;
        justify-content: center;
      }
      
      header {
        padding: 15px 10px;
      }
      
      .tab {
        padding: 10px 15px;
        font-size: 0.9em;
      }
      
      .grade-table {
        font-size: 0.85em;
      }
      
      .grade-input {
        width: 60px;
      }
      
      .project-grid {
        grid-template-columns: 1fr;
      }
      
      .portfolio-stats {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>Student Group Project Management</h1>
  <div id="notificationArea" class="hidden"></div>
</header>

<!-- Login -->
<div class="container login-container" id="loginPage">
  <div class="card">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username (e.g. teacher1, prof_smith)">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p id="errorMsg" style="color:red; text-align: center; margin-top: 15px;"></p>
  </div>
</div>

<!-- Teacher Dashboard -->
<div id="teacherDashboard" class="container hidden">
  <div class="user-info">
    Logged in as: <span id="teacherUsername"></span>
    <button onclick="logout()" class="secondary" style="padding: 6px 12px; font-size: 0.85em;">Logout</button>
  </div>
  
  <h2>Teacher Dashboard</h2>
  
  <div id="teacherAlert"></div>
  
  <div class="tabs">
    <div class="tab active" onclick="switchTab('createGroupTab')">Create Group</div>
    <div class="tab" onclick="switchTab('manageGroupsTab')">Manage Groups</div>
    <div class="tab" onclick="switchTab('gradingTab')">Grading</div>
    <div class="tab" onclick="switchTab('projectHistoryTab')">Project History
      <span id="historyNotificationBadge" class="notification-badge hidden"></span>
    </div>
    <div class="tab" onclick="switchTab('notificationsTab')">Notifications
      <span id="teacherNotificationBadge" class="notification-badge hidden"></span>
    </div>
  </div>
  
  <div id="createGroupTab" class="tab-content active">
    <div class="card">
      <h3>Create Group & Assign Project</h3>
      <input type="text" id="groupName" placeholder="Group Name" required>
      <input type="text" id="studentList" placeholder="Student usernames (comma separated)" required>
      <input type="text" id="projectTitle" placeholder="Project Title" required>
      <select id="projectType">
        <option value="">Select Project Type</option>
        <option value="Web Development">Web Development</option>
        <option value="Mobile App">Mobile App</option>
        <option value="Research Paper">Research Paper</option>
        <option value="Data Analysis">Data Analysis</option>
        <option value="Design Project">Design Project</option>
        <option value="Other">Other</option>
      </select>
      <textarea id="projectDesc" placeholder="Project Description" rows="4" required></textarea>
      <div style="display: flex; gap: 12px;">
        <input type="date" id="projectDeadline" style="flex: 1;">
        <button onclick="addMilestone()" class="secondary" style="width: auto;">Add Milestone</button>
      </div>
      <div id="milestonesContainer"></div>
      <button onclick="createGroup()">Create Group</button>
    </div>
  </div>
  
  <div id="manageGroupsTab" class="tab-content">
    <div class="card">
      <h3>Manage Groups</h3>
      <div class="teacher-selector">
        <label for="teacherFilter">Filter by Teacher:</label>
        <select id="teacherFilter" onchange="filterGroupsByTeacher()">
          <option value="all">All Teachers</option>
          <option value="teacher1">Prof. Smith</option>
          <option value="prof_jones">Dr. Jones</option>
          <option value="dr_williams">Dr. Williams</option>
        </select>
      </div>
      <div id="groupsList"></div>
    </div>
  </div>
  
  <div id="gradingTab" class="tab-content">
    <div class="card">
      <h3>Grade Groups</h3>
      <div class="teacher-selector">
        <label for="gradingTeacherFilter">Filter by Teacher:</label>
        <select id="gradingTeacherFilter" onchange="filterGradingByTeacher()">
          <option value="all">All Teachers</option>
          <option value="teacher1">Prof. Smith</option>
          <option value="prof_jones">Dr. Jones</option>
          <option value="dr_williams">Dr. Williams</option>
        </select>
      </div>
      <div id="gradingContainer"></div>
    </div>
  </div>
  
  <!-- Project History Tab -->
  <div id="projectHistoryTab" class="tab-content">
    <div class="card">
      <h3>Project History & Portfolio</h3>
      <p>View and manage all completed projects</p>
      
      <div class="portfolio-summary">
        <h3>Portfolio Summary</h3>
        <div class="portfolio-stats">
          <div class="portfolio-stat">
            <div class="portfolio-value" id="totalProjects">0</div>
            <div class="portfolio-label">Total Projects</div>
          </div>
          <div class="portfolio-stat">
            <div class="portfolio-value" id="activeProjects">0</div>
            <div class="portfolio-label">Active Projects</div>
          </div>
          <div class="portfolio-stat">
            <div class="portfolio-value" id="completedProjects">0</div>
            <div class="portfolio-label">Completed</div>
          </div>
          <div class="portfolio-stat">
            <div class="portfolio-value" id="avgGrade">-</div>
            <div class="portfolio-label">Average Grade</div>
          </div>
        </div>
      </div>
      
      <div class="project-filter">
        <div class="filter-btn active" onclick="filterProjects('all')">All Projects</div>
        <div class="filter-btn" onclick="filterProjects('active')">Active</div>
        <div class="filter-btn" onclick="filterProjects('completed')">Completed</div>
        <div class="filter-btn" onclick="filterProjects('web')">Web Development</div>
        <div class="filter-btn" onclick="filterProjects('mobile')">Mobile Apps</div>
        <div class="filter-btn" onclick="filterProjects('research')">Research</div>
      </div>
      
      <div class="project-grid" id="projectsGrid">
        <!-- Project cards will be inserted here -->
      </div>
    </div>
  </div>
  
  <div id="notificationsTab" class="tab-content">
    <div class="card">
      <h3>Recent Activity</h3>
      <div id="teacherNotifications"></div>
    </div>
  </div>
</div>

<!-- Student Dashboard -->
<div id="studentDashboard" class="container hidden">
  <div class="user-info">
    Logged in as: <span id="studentUsername"></span>
    <button onclick="logout()" class="secondary" style="padding: 6px 12px; font-size: 0.85em;">Logout</button>
  </div>
  
  <h2>Student Dashboard</h2>
  
  <div id="studentAlert"></div>
  
  <div class="card">
    <h3>Your Group & Project</h3>
    <p id="studentGroup">Not assigned</p>
    <p id="studentProject"></p>
    <div id="studentDeadline"></div>
    <div id="studentGrade" class="hidden">
      <h4>Your Grade</h4>
      <div id="gradeDisplay"></div>
    </div>
  </div>
  
  <!-- Student Project History -->
  <div class="card project-history">
    <h3>Your Project Portfolio</h3>
    <p>Track all your projects and progress</p>
    
    <div class="portfolio-summary">
      <h3>Your Summary</h3>
      <div class="portfolio-stats">
        <div class="portfolio-stat">
          <div class="portfolio-value" id="studentTotalProjects">0</div>
          <div class="portfolio-label">Total Projects</div>
        </div>
        <div class="portfolio-stat">
          <div class="portfolio-value" id="studentCompleted">0</div>
          <div class="portfolio-label">Completed</div>
        </div>
        <div class="portfolio-stat">
          <div class="portfolio-value" id="studentAvgGrade">-</div>
          <div class="portfolio-label">Average Grade</div>
        </div>
        <div class="portfolio-stat">
          <div class="portfolio-value" id="studentProjectTypes">0</div>
          <div class="portfolio-label">Project Types</div>
        </div>
      </div>
    </div>
    
    <div class="history-tabs">
      <div class="history-tab active" onclick="switchHistoryTab('current', 'student')">Current Project</div>
      <div class="history-tab" onclick="switchHistoryTab('past', 'student')">Past Projects</div>
      <div class="history-tab" onclick="switchHistoryTab('portfolio', 'student')">Full Portfolio</div>
    </div>
    
    <div id="currentProjectTab" class="tab-content active">
      <div id="studentCurrentProject"></div>
    </div>
    
    <div id="pastProjectsTab" class="tab-content">
      <div id="studentPastProjects" class="project-grid"></div>
    </div>
    
    <div id="portfolioTab" class="tab-content">
      <div class="project-filter">
        <div class="filter-btn active" onclick="filterStudentProjects('all')">All Projects</div>
        <div class="filter-btn" onclick="filterStudentProjects('completed')">Completed</div>
        <div class="filter-btn" onclick="filterStudentProjects('graded')">Graded</div>
        <div class="filter-btn" onclick="filterStudentProjects('web')">Web Dev</div>
        <div class="filter-btn" onclick="filterStudentProjects('mobile')">Mobile</div>
      </div>
      <div id="studentPortfolio" class="project-grid"></div>
    </div>
  </div>
  
  <div class="tabs">
    <div class="tab active" onclick="switchTab('progressTab', 'student')">Progress Reports</div>
    <div class="tab" onclick="switchTab('chatTab', 'student')">Group Chat
      <span id="chatNotificationBadge" class="notification-badge hidden"></span>
    </div>
    <div class="tab" onclick="switchTab('filesTab', 'student')">Shared Files</div>
  </div>
  
  <div id="progressTab" class="tab-content active">
    <div class="card">
      <h3>Submit Daily Progress</h3>
      <textarea id="progressReport" placeholder="Write today's progress..." rows="4" required></textarea>
      <div class="file-upload">
        <p><strong>Attach files (optional)</strong></p>
        <input type="file" id="fileUpload" multiple>
        <div id="fileList" class="file-list"></div>
      </div>
      <button onclick="submitReport()">Submit</button>
    </div>
    
    <div class="card">
      <h3>Group Progress</h3>
      <div id="progressList"></div>
    </div>
  </div>
  
  <div id="chatTab" class="tab-content">
    <div class="card">
      <div class="chat-header">
        <h3>Group Chat</h3>
        <div class="flex-buttons">
          <button onclick="clearChat()" class="danger">Clear Chat</button>
          <button onclick="refreshChat()" class="secondary">Refresh</button>
        </div>
      </div>
      <div class="chat-box" id="chatBox"></div>
      <div style="display: flex; gap: 12px;">
        <input type="text" id="chatMessage" placeholder="Enter message">
        <button onclick="sendMessage()" style="width: auto;">Send</button>
      </div>
    </div>
  </div>
  
  <div id="filesTab" class="tab-content">
    <div class="card">
      <h3>Shared Files</h3>
      <div class="file-upload">
        <p><strong>Upload a file to share with your group</strong></p>
        <input type="file" id="groupFileUpload">
        <button onclick="uploadFile()" style="margin-top: 10px;">Upload File</button>
      </div>
      <div id="sharedFilesList"></div>
    </div>
  </div>
</div>

<script>
  // Simple hash function for password "hashing" (not secure, for demonstration only)
  function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i);
      hash |= 0; // Convert to 32bit integer
    }
    return hash.toString();
  }

  // Mock users with "hashed" passwords - NOW WITH 3 TEACHERS
  const users = {
    "teacher1": { password: simpleHash("admin"), role: "teacher", name: "Professor Smith" },
    "prof_jones": { password: simpleHash("teach456"), role: "teacher", name: "Dr. Jones" },
    "dr_williams": { password: simpleHash("teach789"), role: "teacher", name: "Dr. Williams" },
    "student1": { password: simpleHash("pass1"), role: "student", name: "Alice Johnson" },
    "student2": { password: simpleHash("pass2"), role: "student", name: "Bob Williams" },
    "student3": { password: simpleHash("pass3"), role: "student", name: "Charlie Brown" },
    "student4": { password: simpleHash("pass4"), role: "student", name: "Diana Miller" },
    "student5": { password: simpleHash("pass5"), role: "student", name: "Ethan Davis" },
    "student6": { password: simpleHash("pass6"), role: "student", name: "Fiona Clark" },
    "student7": { password: simpleHash("pass7"), role: "student", name: "George Wilson" },
    "student8": { password: simpleHash("pass8"), role: "student", name: "Hannah Martinez" },
    "student9": { password: simpleHash("pass9"), role: "student", name: "Ian Anderson" },
    "student10": { password: simpleHash("pass10"), role: "student", name: "Jessica Taylor" }
  };

  // Load project history from localStorage or initialize
  let projectHistory = JSON.parse(localStorage.getItem("projectHistory")) || {
    completedProjects: [
      {
        id: 1,
        name: "Advanced Web App",
        type: "Web Development",
        students: ["student1", "student2", "student3"],
        description: "A full-stack web application with user authentication and database integration",
        deadline: "2023-06-15",
        status: "completed",
        grade: 92,
        completionDate: "2023-06-14",
        createdBy: "teacher1"
      },
      {
        id: 2,
        name: "Mobile Task Manager",
        type: "Mobile App",
        students: ["student4", "student5"],
        description: "A cross-platform mobile application for task management",
        deadline: "2023-05-20",
        status: "completed",
        grade: 88,
        completionDate: "2023-05-18",
        createdBy: "prof_jones"
      }
    ],
    archivedProjects: []
  };

  // Load groups from localStorage or initialize with sample data
  let groups = JSON.parse(localStorage.getItem("groups")) || [
    {
      name: "Group A",
      students: ["student1", "student2", "student3"],
      project: {
        title: "Web Application",
        type: "Web Development",
        desc: "Build a responsive web application with user authentication",
        deadline: new Date(Date.now() + 30 * 86400000).toISOString().split('T')[0],
        milestones: [
          { title: "Design Phase", deadline: new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0], completed: true },
          { title: "Development Phase", deadline: new Date(Date.now() + 21 * 86400000).toISOString().split('T')[0], completed: false }
        ]
      },
      reports: [
        { student: "student1", text: "Worked on the login page design", timestamp: new Date(Date.now() - 86400000).toISOString(), files: [] },
        { student: "student2", text: "Set up the database schema", timestamp: new Date(Date.now() - 172800000).toISOString(), files: [] }
      ],
      chat: [
        { sender: "student1", text: "hi everyone", timestamp: new Date(Date.now() - 3600000).toISOString() },
        { sender: "student2", text: "hello!", timestamp: new Date(Date.now() - 1800000).toISOString() },
        { sender: "student1", text: "how's the project going?", timestamp: new Date(Date.now() - 600000).toISOString() }
      ],
      files: [],
      notifications: [],
      grades: {},
      status: "active",
      createdBy: "teacher1"  // Track which teacher created this group
    },
    {
      name: "Group B",
      students: ["student4", "student5", "student6"],
      project: {
        title: "Mobile App",
        type: "Mobile App",
        desc: "Develop a cross-platform mobile application for task management",
        deadline: new Date(Date.now() + 45 * 86400000).toISOString().split('T')[0],
        milestones: [
          { title: "Research", deadline: new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0], completed: true },
          { title: "UI Design", deadline: new Date(Date.now() + 14 * 86400000).toISOString().split('T')[0], completed: false }
        ]
      },
      reports: [
        { student: "student4", text: "Created the initial app layout", timestamp: new Date(Date.now() - 259200000).toISOString(), files: [] }
      ],
      chat: [
        { sender: "student4", text: "Let's meet tomorrow at 3pm", timestamp: new Date(Date.now() - 86400000).toISOString() }
      ],
      files: [],
      notifications: [],
      grades: {},
      status: "active",
      createdBy: "prof_jones"  // Track which teacher created this group
    }
  ];

  let currentStudentGroup = null;
  let lastChatCheck = {};
  let uploadedFiles = {};

  // Initialize project history display
  function initProjectHistory() {
    updatePortfolioSummary();
    displayAllProjects();
    updateStudentPortfolio();
  }

  // Update portfolio summary statistics
  function updatePortfolioSummary() {
    const activeProjects = groups.filter(g => g.status === "active").length;
    const completedProjects = projectHistory.completedProjects.length;
    const totalProjects = activeProjects + completedProjects;
    
    // Calculate average grade
    let totalGrade = 0;
    let gradedProjects = 0;
    
    projectHistory.completedProjects.forEach(project => {
      if (project.grade) {
        totalGrade += project.grade;
        gradedProjects++;
      }
    });
    
    const avgGrade = gradedProjects > 0 ? (totalGrade / gradedProjects).toFixed(1) : "-";
    
    // Update teacher dashboard
    document.getElementById("totalProjects").textContent = totalProjects;
    document.getElementById("activeProjects").textContent = activeProjects;
    document.getElementById("completedProjects").textContent = completedProjects;
    document.getElementById("avgGrade").textContent = avgGrade;
    
    // Update student dashboard if student is logged in
    if (localStorage.getItem("role") === "student") {
      const username = localStorage.getItem("loggedInUser");
      updateStudentPortfolioSummary(username);
    }
  }

  // Display all projects in the history tab
  function displayAllProjects(filter = "all") {
    const grid = document.getElementById("projectsGrid");
    grid.innerHTML = "";
    
    // Add active projects
    if (filter === "all" || filter === "active") {
      groups.filter(group => group.status === "active").forEach(group => {
        grid.appendChild(createProjectCard(group, "active"));
      });
    }
    
    // Add completed projects
    if (filter === "all" || filter === "completed") {
      projectHistory.completedProjects.forEach(project => {
        if (filter === "all" || 
            (filter === "web" && project.type === "Web Development") ||
            (filter === "mobile" && project.type === "Mobile App") ||
            (filter === "research" && (project.type === "Research Paper" || project.type === "Data Analysis"))) {
          grid.appendChild(createProjectCard(project, "completed"));
        }
      });
    }
  }

  // Create a project card element
  function createProjectCard(project, status) {
    const card = document.createElement("div");
    card.className = "project-card";
    
    const isActive = status === "active";
    const isGroup = project.hasOwnProperty("students");
    
    // Get teacher name for display
    const teacherUsername = project.createdBy || (isGroup ? project.createdBy : "");
    const teacherName = teacherUsername && users[teacherUsername] ? users[teacherUsername].name : "Unknown Teacher";
    
    card.innerHTML = `
      <div class="project-header">
        <h3>${project.name || project.project.title}</h3>
        <div class="project-type">${project.type || project.project.type}</div>
      </div>
      <div class="project-body">
        <p>${project.description || project.project.desc}</p>
        <p><small>Created by: ${teacherName}</small></p>
        
        <div class="project-stats">
          <div class="stat">
            <div class="stat-value">${isGroup ? project.students.length : project.students.length}</div>
            <div class="stat-label">Members</div>
          </div>
          <div class="stat">
            <div class="stat-value">${isActive ? "Active" : (project.grade ? project.grade + "%" : "Completed")}</div>
            <div class="stat-label">Status</div>
          </div>
        </div>
        
        ${isActive ? `
          <button class="archive-btn" onclick="archiveProject('${project.name}')">Archive Project</button>
        ` : `
          <div class="timestamp">Completed: ${formatDate(project.completionDate)}</div>
        `}
      </div>
    `;
    
    return card;
  }

  // Archive a project (move from active to history)
  function archiveProject(projectName) {
    if (confirm(`Are you sure you want to archive "${projectName}"? This will move it to project history.`)) {
      const groupIndex = groups.findIndex(g => g.name === projectName);
      
      if (groupIndex !== -1) {
        const group = groups[groupIndex];
        
        // Create a completed project object
        const completedProject = {
          id: Date.now(),
          name: group.name,
          type: group.project.type,
          students: group.students,
          description: group.project.desc,
          deadline: group.project.deadline,
          status: "completed",
          completionDate: new Date().toISOString().split('T')[0],
          createdBy: group.createdBy || localStorage.getItem("loggedInUser")
        };
        
        // Add grade if available
        if (Object.keys(group.grades).length > 0) {
          // Calculate average grade
          let totalGrade = 0;
          let count = 0;
          
          for (const student in group.grades) {
            totalGrade += group.grades[student].grade;
            count++;
          }
          
          completedProject.grade = Math.round(totalGrade / count);
        }
        
        // Add to project history
        projectHistory.completedProjects.push(completedProject);
        
        // Remove from active groups
        groups.splice(groupIndex, 1);
        
        // Save to localStorage
        localStorage.setItem("groups", JSON.stringify(groups));
        localStorage.setItem("projectHistory", JSON.stringify(projectHistory));
        
        // Update UI
        updateGroupsList();
        displayAllProjects();
        updatePortfolioSummary();
        
        showAlert("teacher", `Project "${projectName}" has been archived`, "success");
      }
    }
  }

  // Filter projects by type/status
  function filterProjects(filter) {
    // Update active filter button
    document.querySelectorAll(".filter-btn").forEach(btn => {
      btn.classList.remove("active");
    });
    event.target.classList.add("active");
    
    displayAllProjects(filter);
  }

  // NEW: Filter groups by teacher
  function filterGroupsByTeacher() {
    const teacherFilter = document.getElementById("teacherFilter").value;
    updateGroupsList(teacherFilter);
  }

  // NEW: Filter grading by teacher
  function filterGradingByTeacher() {
    const teacherFilter = document.getElementById("gradingTeacherFilter").value;
    updateGradingTab(teacherFilter);
  }

  // Update student portfolio summary
  function updateStudentPortfolioSummary(username) {
    // Count projects the student is involved in
    const activeProjects = groups.filter(g => g.status === "active" && g.students.includes(username)).length;
    const completedProjects = projectHistory.completedProjects.filter(p => p.students.includes(username)).length;
    const totalProjects = activeProjects + completedProjects;
    
    // Calculate average grade
    let totalGrade = 0;
    let gradedProjects = 0;
    
    projectHistory.completedProjects.forEach(project => {
      if (project.grade && project.students.includes(username)) {
        totalGrade += project.grade;
        gradedProjects++;
      }
    });
    
    // Count unique project types
    const projectTypes = new Set();
    
    groups.forEach(group => {
      if (group.students.includes(username) && group.status === "active") {
        projectTypes.add(group.project.type);
      }
    });
    
    projectHistory.completedProjects.forEach(project => {
      if (project.students.includes(username)) {
        projectTypes.add(project.type);
      }
    });
    
    const avgGrade = gradedProjects > 0 ? (totalGrade / gradedProjects).toFixed(1) : "-";
    
    // Update student dashboard
    document.getElementById("studentTotalProjects").textContent = totalProjects;
    document.getElementById("studentCompleted").textContent = completedProjects;
    document.getElementById("studentAvgGrade").textContent = avgGrade;
    document.getElementById("studentProjectTypes").textContent = projectTypes.size;
  }

  // Update student portfolio view
  function updateStudentPortfolio() {
    const username = localStorage.getItem("loggedInUser");
    if (!username) return;
    
    const currentContainer = document.getElementById("studentCurrentProject");
    const pastContainer = document.getElementById("studentPastProjects");
    const portfolioContainer = document.getElementById("studentPortfolio");
    
    // Clear containers
    currentContainer.innerHTML = "";
    pastContainer.innerHTML = "";
    portfolioContainer.innerHTML = "";
    
    // Add current project
    const currentGroup = groups.find(g => g.students.includes(username) && g.status === "active");
    if (currentGroup) {
      currentContainer.appendChild(createProjectCard(currentGroup, "active"));
    } else {
      currentContainer.innerHTML = "<p>You are not currently part of any active project.</p>";
    }
    
    // Add past projects
    const pastProjects = projectHistory.completedProjects.filter(p => p.students.includes(username));
    if (pastProjects.length > 0) {
      pastProjects.forEach(project => {
        pastContainer.appendChild(createProjectCard(project, "completed"));
      });
    } else {
      pastContainer.innerHTML = "<p>You haven't completed any projects yet.</p>";
    }
    
    // Add all projects to portfolio
    if (currentGroup) {
      portfolioContainer.appendChild(createProjectCard(currentGroup, "active"));
    }
    
    pastProjects.forEach(project => {
      portfolioContainer.appendChild(createProjectCard(project, "completed"));
    });
    
    if (portfolioContainer.innerHTML === "") {
      portfolioContainer.innerHTML = "<p>No projects to display.</p>";
    }
    
    updateStudentPortfolioSummary(username);
  }

  // Filter student projects
  function filterStudentProjects(filter) {
    const username = localStorage.getItem("loggedInUser");
    if (!username) return;
    
    // Update active filter button
    const buttons = event.target.parentElement.querySelectorAll(".filter-btn");
    buttons.forEach(btn => {
      btn.classList.remove("active");
    });
    event.target.classList.add("active");
    
    const portfolioContainer = document.getElementById("studentPortfolio");
    portfolioContainer.innerHTML = "";
    
    // Add filtered projects
    if (filter === "all") {
      // Add current project
      const currentGroup = groups.find(g => g.students.includes(username) && g.status === "active");
      if (currentGroup) {
        portfolioContainer.appendChild(createProjectCard(currentGroup, "active"));
      }
      
      // Add completed projects
      projectHistory.completedProjects
        .filter(p => p.students.includes(username))
        .forEach(project => {
          portfolioContainer.appendChild(createProjectCard(project, "completed"));
        });
    } 
    else if (filter === "completed") {
      projectHistory.completedProjects
        .filter(p => p.students.includes(username))
        .forEach(project => {
          portfolioContainer.appendChild(createProjectCard(project, "completed"));
        });
    }
    else if (filter === "graded") {
      projectHistory.completedProjects
        .filter(p => p.students.includes(username) && p.grade)
        .forEach(project => {
          portfolioContainer.appendChild(createProjectCard(project, "completed"));
        });
    }
    else if (filter === "web") {
      // Add current web projects
      const currentGroup = groups.find(g => 
        g.students.includes(username) && 
        g.status === "active" && 
        g.project.type === "Web Development"
      );
      if (currentGroup) {
        portfolioContainer.appendChild(createProjectCard(currentGroup, "active"));
      }
      
      // Add completed web projects
      projectHistory.completedProjects
        .filter(p => p.students.includes(username) && p.type === "Web Development")
        .forEach(project => {
          portfolioContainer.appendChild(createProjectCard(project, "completed"));
        });
    }
    else if (filter === "mobile") {
      // Add current mobile projects
      const currentGroup = groups.find(g => 
        g.students.includes(username) && 
        g.status === "active" && 
        g.project.type === "Mobile App"
      );
      if (currentGroup) {
        portfolioContainer.appendChild(createProjectCard(currentGroup, "active"));
      }
      
      // Add completed mobile projects
      projectHistory.completedProjects
        .filter(p => p.students.includes(username) && p.type === "Mobile App")
        .forEach(project => {
          portfolioContainer.appendChild(createProjectCard(project, "completed"));
        });
    }
    
    if (portfolioContainer.innerHTML === "") {
      portfolioContainer.innerHTML = "<p>No projects match the selected filter.</p>";
    }
  }

  // Switch between history tabs (student view)
  function switchHistoryTab(tabId, dashboard) {
    document.querySelectorAll(`#${dashboard}Dashboard .history-tab`).forEach(tab => {
      tab.classList.remove("active");
    });
    event.target.classList.add("active");
    
    document.querySelectorAll(`#${dashboard}Dashboard .tab-content`).forEach(content => {
      content.classList.remove("active");
    });
    document.getElementById(tabId + "Tab").classList.add("active");
  }

  function login() {
    let username = document.getElementById("username").value.trim();
    let password = document.getElementById("password").value.trim();
    let errorMsg = document.getElementById("errorMsg");

    if (users[username] && users[username].password === simpleHash(password)) {
      localStorage.setItem("loggedInUser", username);
      localStorage.setItem("role", users[username].role);
      showDashboard(users[username].role, username);
      errorMsg.innerText = "";
    } else {
      errorMsg.innerText = "Invalid credentials!";
    }
  }

  function showDashboard(role, username) {
    document.getElementById("loginPage").classList.add("hidden");
    if (role === "teacher") {
      document.getElementById("teacherDashboard").classList.remove("hidden");
      document.getElementById("teacherUsername").textContent = users[username].name;
      updateGroupsList();
      checkTeacherNotifications();
      updateGradingTab();
      initProjectHistory();
    } else {
      document.getElementById("studentDashboard").classList.remove("hidden");
      document.getElementById("studentUsername").textContent = users[username].name;
      loadStudentView(username);
      // Initialize last chat check time
      lastChatCheck[username] = new Date().toISOString();
    }
  }

  function addMilestone() {
    const container = document.getElementById("milestonesContainer");
    const milestoneId = Date.now(); // Unique ID
    container.innerHTML += `
      <div class="milestone" id="milestone-${milestoneId}" style="display: flex; gap: 12px; align-items: center; margin: 10px 0;">
        <input type="text" placeholder="Milestone title" style="flex: 2;">
        <input type="date" style="flex: 1;">
        <button onclick="document.getElementById('milestone-${milestoneId}').remove()" class="danger" style="width: auto; padding: 10px;">Remove</button>
      </div>
    `;
  }

  function createGroup() {
    let groupName = document.getElementById("groupName").value.trim();
    let studentsInput = document.getElementById("studentList").value.trim();
    let projectTitle = document.getElementById("projectTitle").value.trim();
    let projectType = document.getElementById("projectType").value;
    let projectDesc = document.getElementById("projectDesc").value.trim();
    let projectDeadline = document.getElementById("projectDeadline").value;
    
    // Validate inputs
    if (!groupName || !studentsInput || !projectTitle || !projectType) {
      showAlert("teacher", "Please fill all required fields", "error");
      return;
    }
    
    let students = studentsInput.split(",").map(s => s.trim());
    
    // Validate student usernames
    let invalidStudents = students.filter(s => !users[s] || users[s].role !== "student");
    if (invalidStudents.length > 0) {
      showAlert("teacher", `Invalid student usernames: ${invalidStudents.join(", ")}`, "error");
      return;
    }
    
    // Check if group name already exists
    if (groups.some(g => g.name === groupName)) {
      showAlert("teacher", "Group name already exists", "error");
      return;
    }

    // Collect milestones
    const milestones = [];
    const milestoneElements = document.querySelectorAll('.milestone');
    milestoneElements.forEach(el => {
      const title = el.querySelector('input[type="text"]').value.trim();
      const deadline = el.querySelector('input[type="date"]').value;
      if (title && deadline) {
        milestones.push({ title, deadline, completed: false });
      }
    });

    let group = { 
      name: groupName, 
      students, 
      project: { 
        title: projectTitle, 
        type: projectType,
        desc: projectDesc,
        deadline: projectDeadline,
        milestones 
      }, 
      reports: [], 
      chat: [],
      files: [],
      notifications: [`Group "${groupName}" was created with project "${projectTitle}"`],
      grades: {},
      status: "active",
      createdBy: localStorage.getItem("loggedInUser") // Track which teacher created the group
    };
    
    groups.push(group);
    localStorage.setItem("groups", JSON.stringify(groups));

    // Clear form
    document.getElementById("groupName").value = "";
    document.getElementById("studentList").value = "";
    document.getElementById("projectTitle").value = "";
    document.getElementById("projectType").value = "";
    document.getElementById("projectDesc").value = "";
    document.getElementById("projectDeadline").value = "";
    document.getElementById("milestonesContainer").innerHTML = "";
    
    showAlert("teacher", "Group Created & Project Assigned!", "success");
    updateGroupsList();
    updateGradingTab();
    updatePortfolioSummary();
  }

  // Update groups list with teacher filtering
  function updateGroupsList(teacherFilter = "all") {
    let list = document.getElementById("groupsList");
    list.innerHTML = "";
    
    let filteredGroups = groups;
    if (teacherFilter !== "all") {
      filteredGroups = groups.filter(group => group.createdBy === teacherFilter);
    }
    
    if (filteredGroups.length === 0) {
      list.innerHTML = "<p>No groups found.</p>";
      return;
    }
    
    filteredGroups.forEach((group, index) => {
      // Check if project is nearing deadline (within 7 days)
      const today = new Date();
      const deadline = new Date(group.project.deadline);
      const daysUntilDeadline = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
      const isDeadlineNear = daysUntilDeadline <= 7 && daysUntilDeadline >= 0;
      
      // Get teacher name for display
      const teacherName = group.createdBy && users[group.createdBy] ? users[group.createdBy].name : "Unknown Teacher";
      
      list.innerHTML += `
        <div class="card group-card">
          <b>${group.name}</b> ${isDeadlineNear ? '<span style="color: #dc3545;">(Deadline approaching!)</span>' : ''}<br>
          <p><strong>Teacher:</strong> ${teacherName}</p>
          <p><strong>Students:</strong> ${group.students.join(", ")}</p>
          <p><strong>Project:</strong> ${group.project.title} - ${group.project.desc}</p>
          <p><strong>Deadline:</strong> ${formatDate(group.project.deadline)} (${daysUntilDeadline} days left)</p>
          ${group.project.milestones && group.project.milestones.length > 0 ? `
            <p><strong>Milestones:</strong></p>
            <ul>${group.project.milestones.map(m => `
              <li>${m.title} - ${formatDate(m.deadline)} ${m.completed ? '✅' : '⏳'}</li>
            `).join("")}</ul>
          ` : ''}
          ${group.reports.length > 0 ? `
            <p><strong>Recent Reports:</strong></p>
            <ul>${group.reports.slice(-3).map(r => `
              <li>${r.student}: ${r.text} <span class="timestamp">${formatDate(r.timestamp)}</span></li>
            `).join("")}</ul>
          ` : "<p>No progress reports yet.</p>"}
          <div class="group-buttons">
            <button onclick="editGroup(${groups.findIndex(g => g.name === group.name)})" class="secondary">Edit Group</button>
            <button onclick="deleteGroup(${groups.findIndex(g => g.name === group.name)})" class="danger">Delete Group</button>
          </div>
        </div>
      `;
    });
  }

  // Update grading tab with teacher filtering
  function updateGradingTab(teacherFilter = "all") {
    const container = document.getElementById("gradingContainer");
    container.innerHTML = "";
    
    let filteredGroups = groups;
    if (teacherFilter !== "all") {
      filteredGroups = groups.filter(group => group.createdBy === teacherFilter);
    }
    
    if (filteredGroups.length === 0) {
      container.innerHTML = "<p>No groups found.</p>";
      return;
    }
    
    filteredGroups.forEach((group, groupIndex) => {
      const actualIndex = groups.findIndex(g => g.name === group.name);
      const groupCard = document.createElement("div");
      groupCard.className = "card";
      
      // Get teacher name for display
      const teacherName = group.createdBy && users[group.createdBy] ? users[group.createdBy].name : "Unknown Teacher";
      
      groupCard.innerHTML = `
        <h3>Grade: ${group.name} (by ${teacherName})</h3>
        <p><strong>Project:</strong> ${group.project.title}</p>
        <p><strong>Students:</strong> ${group.students.join(", ")}</p>
        
        <table class="grade-table">
          <thead>
            <tr>
              <th>Student</th>
              <th>Grade (0-100)</th>
              <th>Letter Grade</th>
              <th>Feedback</th>
            </tr>
          </thead>
          <tbody id="gradeTable-${actualIndex}">
          </tbody>
        </table>
        
        <div class="grade-summary">
          <h4>Group Summary</h4>
          <div id="groupSummary-${actualIndex}">No grades entered yet</div>
        </div>
        
        <button onclick="saveGrades(${actualIndex})" style="margin-top: 15px;">Save Grades</button>
      `;
      
      container.appendChild(groupCard);
      
      // Fill in the grade table
      const tableBody = document.getElementById(`gradeTable-${actualIndex}`);
      group.students.forEach((student, studentIndex) => {
        const grade = group.grades && group.grades[student] ? group.grades[student].grade : "";
        const feedback = group.grades && group.grades[student] ? group.grades[student].feedback : "";
        const letterGrade = calculateLetterGrade(grade);
        
        tableBody.innerHTML += `
          <tr>
            <td>${student}</td>
            <td>
              <input type="number" min="0" max="100" class="grade-input" 
                     id="grade-${actualIndex}-${studentIndex}" 
                     value="${grade}" 
                     onchange="updateLetterGrade(${actualIndex}, ${studentIndex})">
            </td>
            <td id="letterGrade-${actualIndex}-${studentIndex}">
              ${letterGrade ? `<span class="grade-badge grade-${letterGrade}">${letterGrade}</span>` : ""}
            </td>
            <td>
              <input type="text" 
                     id="feedback-${actualIndex}-${studentIndex}" 
                     value="${feedback}" 
                     placeholder="Optional feedback">
            </td>
          </tr>
        `;
      });
      
      updateGroupSummary(actualIndex);
    });
  }

  // Calculate letter grade based on numerical grade
  function calculateLetterGrade(grade) {
    if (!grade || isNaN(grade)) return "";
    if (grade >= 90) return "A";
    if (grade >= 80) return "B";
    if (grade >= 70) return "C";
    if (grade >= 60) return "D";
    return "F";
  }
  
  // Update letter grade display when numerical grade changes
  function updateLetterGrade(groupIndex, studentIndex) {
    const gradeInput = document.getElementById(`grade-${groupIndex}-${studentIndex}`);
    const letterGradeCell = document.getElementById(`letterGrade-${groupIndex}-${studentIndex}`);
    const grade = parseInt(gradeInput.value);
    
    if (!isNaN(grade) && grade >= 0 && grade <= 100) {
      const letterGrade = calculateLetterGrade(grade);
      letterGradeCell.innerHTML = `<span class="grade-badge grade-${letterGrade}">${letterGrade}</span>`;
    } else {
      letterGradeCell.innerHTML = "";
    }
    
    updateGroupSummary(groupIndex);
  }
  
  // Update group summary statistics
  function updateGroupSummary(groupIndex) {
    const group = groups[groupIndex];
    const summaryElement = document.getElementById(`groupSummary-${groupIndex}`);
    const grades = [];
    
    group.students.forEach((student, studentIndex) => {
      const gradeInput = document.getElementById(`grade-${groupIndex}-${studentIndex}`);
      const grade = parseInt(gradeInput.value);
      
      if (!isNaN(grade) && grade >= 0 && grade <= 100) {
        grades.push(grade);
      }
    });
    
    if (grades.length === 0) {
      summaryElement.innerHTML = "No grades entered yet";
      return;
    }
    
    const average = grades.reduce((a, b) => a + b, 0) / grades.length;
    const min = Math.min(...grades);
    const max = Math.max(...grades);
    
    summaryElement.innerHTML = `
      <p><strong>Average:</strong> ${average.toFixed(1)}% (${calculateLetterGrade(average)})</p>
      <p><strong>Range:</strong> ${min}% - ${max}%</p>
      <p><strong>Graded:</strong> ${grades.length} of ${group.students.length} students</p>
    `;
  }
  
  // Save grades for a group
  function saveGrades(groupIndex) {
    const group = groups[groupIndex];
    
    group.students.forEach((student, studentIndex) => {
      const gradeInput = document.getElementById(`grade-${groupIndex}-${studentIndex}`);
      const feedbackInput = document.getElementById(`feedback-${groupIndex}-${studentIndex}`);
      const grade = parseInt(gradeInput.value);
      
      if (!group.grades) {
        group.grades = {};
      }
      
      if (!isNaN(grade) && grade >= 0 && grade <= 100) {
        group.grades[student] = {
          grade: grade,
          feedback: feedbackInput.value,
          timestamp: new Date().toISOString()
        };
      } else if (gradeInput.value === "") {
        // Clear grade if input is empty
        if (group.grades[student]) {
          delete group.grades[student];
        }
      }
    });
    
    localStorage.setItem("groups", JSON.stringify(groups));
    showAlert("teacher", "Grades saved successfully!", "success");
    updateGroupSummary(groupIndex);
    
    // Add notification
    group.notifications.push(`Grades updated for ${group.name}`);
    
    // Update student views if they're logged in
    updateStudentGradeDisplays();
  }
  
  // Update grade displays for students
  function updateStudentGradeDisplays() {
    const currentUser = localStorage.getItem("loggedInUser");
    const role = localStorage.getItem("role");
    
    if (role === "student") {
      loadStudentView(currentUser);
    }
  }

  function loadStudentView(username) {
    let group = groups.find(g => g.students.includes(username));
    if (group) {
      document.getElementById("studentGroup").innerText = `Group: ${group.name}`;
      document.getElementById("studentProject").innerHTML = `<b>${group.project.title}</b><br>${group.project.desc}`;
      
      // Show deadline information
      const today = new Date();
      const deadline = new Date(group.project.deadline);
      const daysUntilDeadline = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
      
      let deadlineClass = "deadline";
      if (daysUntilDeadline <= 7 && daysUntilDeadline >= 0) {
        deadlineClass += " urgent";
      }
      
      document.getElementById("studentDeadline").innerHTML = `
        <div class="${deadlineClass}">
          <strong>Project Deadline:</strong> ${formatDate(group.project.deadline)} 
          (${daysUntilDeadline > 0 ? `${daysUntilDeadline} days left` : 'Deadline passed!'})
        </div>
      `;
      
      // Display grade if available
      const gradeDisplay = document.getElementById("gradeDisplay");
      const studentGradeSection = document.getElementById("studentGrade");
      
      if (group.grades && group.grades[username]) {
        const gradeData = group.grades[username];
        const letterGrade = calculateLetterGrade(gradeData.grade);
        
        gradeDisplay.innerHTML = `
          <div class="grade-summary">
            <p><strong>Grade:</strong> ${gradeData.grade}% 
              <span class="grade-badge grade-${letterGrade}">${letterGrade}</span>
            </p>
            ${gradeData.feedback ? `<p><strong>Feedback:</strong> ${gradeData.feedback}</p>` : ""}
            <span class="timestamp">Graded on: ${formatDate(gradeData.timestamp)}</span>
          </div>
        `;
        studentGradeSection.classList.remove("hidden");
      } else {
        studentGradeSection.classList.add("hidden");
      }
      
      updateProgressList(group);
      updateChat(group);
      updateSharedFiles(group);
      checkChatNotifications(username, group);
      currentStudentGroup = group;
    } else {
      document.getElementById("studentGroup").innerText = "You are not assigned to any group yet.";
      document.getElementById("studentGrade").classList.add("hidden");
    }
    
    // Handle file input change
    document.getElementById('fileUpload').addEventListener('change', handleFileSelect);
    updateStudentPortfolio();
  }

  // ... (rest of the existing functions remain the same)

  // Auto-login if session exists
  window.onload = () => {
    let user = localStorage.getItem("loggedInUser");
    let role = localStorage.getItem("role");
    if (user && role) showDashboard(role, user);
  };
</script>

</body>
</html>
